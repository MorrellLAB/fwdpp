<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>fwdpp: Tutorial 3: Data serialization</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">fwdpp
   &#160;<span id="projectnumber">0.2.9</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Tutorial 3: Data serialization </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Intro</h2>
<p>This tutorial covers the following topics:</p>
<ul>
<li>Writing simulated populations to files, and reading them back in</li>
<li>Copying simulated population in memory</li>
</ul>
<h2>The basic functions</h2>
<p>For single-deme simulations, the library provides the following functions:</p>
<ul>
<li><a class="el" href="../../da/d8b/namespaceKTfwd.html#a7e61ead953245fa0179b92971ad9dc1f">KTfwd::write_binary_pop</a></li>
<li><a class="el" href="../../da/d8b/namespaceKTfwd.html#aa86f256af3adb31cc09ad797b3d76c6e" title="Read the population back from a binary-format file Read the population back from a binary-format file...">KTfwd::read_binary_pop</a></li>
</ul>
<p>These functions write and read simulated populations in a binary (<em>e.g.</em> not human-readable) format.</p>
<p>For multi-deme simulations, we have:</p>
<ul>
<li><a class="el" href="../../da/d8b/namespaceKTfwd.html#a21e90a90f379efd81081f3c07c9e5507" title="Write the metapopulation to a compact binary-format output file. Write the metapopulation to a compac...">KTfwd::write_binary_metapop</a></li>
<li><a class="el" href="../../da/d8b/namespaceKTfwd.html#a2360771e6340d7ed72fb69a4d7869d0f" title="Read the metapopulation back from a binary-format file Read the metapopulation back from a binary-for...">KTfwd::read_binary_metapop</a></li>
</ul>
<p>As with the rest of the library, these functions are implemented using a combination of templates + function overloading.</p>
<p>Currently, these functions support the following types of simulations:</p>
<ul>
<li>single-locus, single-deme, gamete-based</li>
<li>single-locus, multi-deme, gamete-based</li>
<li>single-locus, single-deme, individual-based</li>
<li>single-locus, multi-deme, individual-based</li>
<li>multi-locus, single-deme, individual-based</li>
</ul>
<p>The type requirements for these functions are:</p>
<ul>
<li>Containers of objects used in fwdpp-based simulations (containers of gametes, mutations, diploids, etc.)</li>
<li>Output streams compatible with the public interface of <a href="http://www.cplusplus.com/reference/ostream/ostream/">std::ostream</a></li>
<li>Input streams compatible with the public interfact of <a href="http://www.cplusplus.com/reference/istream/istream/">std::istream</a></li>
<li>Input via the gzFile type defined by <a href="http://zlib.net">zlib</a></li>
</ul>
<h2>Writing and reading mutations</h2>
<p>You need to tell these functions how to read/write mutation objects. Specifically, you need to:</p>
<ul>
<li>Define a mutation write function, which takes a mutation object and an output stream type as an object.</li>
<li>Define a mutation read function, taking an input stream type as an object</li>
</ul>
<p>Let's look at an example. For this definition of a mutation type:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="../../de/d4d/structmutation__with__age.html">mutation_with_age</a> : <span class="keyword">public</span> <a class="code" href="../../d1/da4/structKTfwd_1_1mutation__base.html">KTfwd::mutation_base</a></div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="../../de/d4d/structmutation__with__age.html#a85f3c3c62fb469e3e38e5a5b3ec2d5dc">s</a>,<a class="code" href="../../de/d4d/structmutation__with__age.html#ad3b51b282581737f217cbd918fa800dc">h</a>;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <a class="code" href="../../de/d4d/structmutation__with__age.html#a6911001ce7dcd8114e89ff7494fc2703">g</a>; <span class="comment">//generation in which mutation arose</span></div>
<div class="line">  <a class="code" href="../../de/d4d/structmutation__with__age.html#aeae6a32f9e7c790773cf94bb004d435d">mutation_with_age</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> &amp; __o,<span class="keyword">const</span> <span class="keywordtype">double</span> &amp; position, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> &amp; count, </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; __s, <span class="keyword">const</span> <span class="keywordtype">double</span> __h,</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">bool</span> &amp; isneutral = <span class="keyword">true</span>)</div>
<div class="line">    : KTfwd::<a class="code" href="../../d1/da4/structKTfwd_1_1mutation__base.html#a73b18577e5d041ad1822663335477862">mutation_base</a>(position,count,isneutral),s(__s),h(__h),g(__o)</div>
<div class="line">  {     </div>
<div class="line">  }</div>
<div class="line">};</div>
</div><!-- fragment --><p>This function object works as a writer:</p>
<div class="fragment"><div class="line"><span class="comment">//function object to write mutation data in binary format</span></div>
<div class="line"><span class="keyword">struct </span><a class="code" href="../../db/d91/structmwriter.html">mwriter</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">typedef</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d91/structmwriter.html#a4c2186e1cd2e69b3a695960eecfa5c50">result_type</a>;</div>
<div class="line">  <a class="code" href="../../db/d91/structmwriter.html#a4c2186e1cd2e69b3a695960eecfa5c50">result_type</a> <a class="code" href="../../db/d91/structmwriter.html#a66f5d25f9e132257328a29c6e715d77a">operator()</a>( <span class="keyword">const</span> <a class="code" href="../../de/d4d/structmutation__with__age.html">mutation_with_age</a> &amp; m, std::ostream &amp; buffer )<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordtype">unsigned</span> u = m.<a class="code" href="../../d1/da4/structKTfwd_1_1mutation__base.html#a9df75224a5f00b97dc09e68b475a517a">n</a>;</div>
<div class="line">    buffer.write( reinterpret_cast&lt; char * &gt;(&amp;u),<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span>) );</div>
<div class="line">    u = m.<a class="code" href="../../de/d4d/structmutation__with__age.html#a6911001ce7dcd8114e89ff7494fc2703">g</a>;</div>
<div class="line">    buffer.write( reinterpret_cast&lt; char * &gt;(&amp;u),<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span>) );</div>
<div class="line">    <span class="keywordtype">bool</span> b = m.<a class="code" href="../../d1/da4/structKTfwd_1_1mutation__base.html#acfb3b4c94516cbbc5c28a12e1ad575b3">neutral</a>;</div>
<div class="line">    buffer.write( reinterpret_cast&lt; char * &gt;(&amp;b),<span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>) );</div>
<div class="line">    <span class="keywordtype">double</span> d = m.<a class="code" href="../../d1/da4/structKTfwd_1_1mutation__base.html#aed95181f38c8e17b19a7a9da4b373b03">pos</a>;</div>
<div class="line">    buffer.write( reinterpret_cast&lt; char * &gt;(&amp;d),<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) );</div>
<div class="line">    d = m.<a class="code" href="../../de/d4d/structmutation__with__age.html#a85f3c3c62fb469e3e38e5a5b3ec2d5dc">s</a>;</div>
<div class="line">    buffer.write( reinterpret_cast&lt; char * &gt;(&amp;d),<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) );</div>
<div class="line">    d = m.<a class="code" href="../../de/d4d/structmutation__with__age.html#ad3b51b282581737f217cbd918fa800dc">h</a>;</div>
<div class="line">    buffer.write( reinterpret_cast&lt; char * &gt;(&amp;d),<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) );</div>
<div class="line">  }</div>
<div class="line">};</div>
</div><!-- fragment --><p>And this function object works as a reader:</p>
<div class="fragment"><div class="line"><span class="comment">//function object to read mutation data in binary format</span></div>
<div class="line"><span class="keyword">struct </span><a class="code" href="../../d9/d61/structmreader.html">mreader</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">typedef</span> <a class="code" href="../../de/d4d/structmutation__with__age.html">mutation_with_age</a> <a class="code" href="../../d9/d61/structmreader.html#a018bc865eec84fdf7dc5fa8dd79089da">result_type</a>;</div>
<div class="line">  <a class="code" href="../../d9/d61/structmreader.html#a018bc865eec84fdf7dc5fa8dd79089da">result_type</a> <a class="code" href="../../d9/d61/structmreader.html#a5a87ded6097d21b6c26f6411cc064efd">operator()</a>( std::istream &amp; in )<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordtype">unsigned</span> n;</div>
<div class="line">    in.read( reinterpret_cast&lt; char * &gt;(&amp;n),<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span>) );</div>
<div class="line">    <span class="keywordtype">unsigned</span> g;</div>
<div class="line">    in.read( reinterpret_cast&lt; char * &gt;(&amp;g),<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span>) );</div>
<div class="line">    <span class="keywordtype">bool</span> neut;</div>
<div class="line">    in.read( reinterpret_cast&lt; char * &gt;(&amp;neut),<span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>) );</div>
<div class="line">    <span class="keywordtype">double</span> pos;</div>
<div class="line">    in.read( reinterpret_cast&lt; char * &gt;(&amp;pos),<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) );</div>
<div class="line">    <span class="keywordtype">double</span> s;</div>
<div class="line">    in.read( reinterpret_cast&lt; char * &gt;(&amp;s),<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) );</div>
<div class="line">    <span class="keywordtype">double</span> h;</div>
<div class="line">    in.read( reinterpret_cast&lt; char * &gt;(&amp;h),<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) );</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="../../d9/d61/structmreader.html#a018bc865eec84fdf7dc5fa8dd79089da">result_type</a>(g,pos,n,s,h,neut);</div>
<div class="line">  }</div>
<div class="line">};</div>
</div><!-- fragment --><p>In the next section, you'll see how to pass these to <a class="el" href="../../da/d8b/namespaceKTfwd.html#a7e61ead953245fa0179b92971ad9dc1f">KTfwd::write_binary_pop</a> and <a class="el" href="../../da/d8b/namespaceKTfwd.html#aa86f256af3adb31cc09ad797b3d76c6e" title="Read the population back from a binary-format file Read the population back from a binary-format file...">KTfwd::read_binary_pop</a>.</p>
<h2>In-memory copying</h2>
<p>It may be desirable to be able to restore a population from a previous state. For example, you may wish to repeatedly introduce a mutation at a position, and then simulate until it is fixed. For replicates where it is lost, you will restore the population to the state it was in when you introduced the mutation. You may do this using <a class="el" href="../../da/d8b/namespaceKTfwd.html#a7e61ead953245fa0179b92971ad9dc1f">KTfwd::write_binary_pop</a> or <a class="el" href="../../da/d8b/namespaceKTfwd.html#a21e90a90f379efd81081f3c07c9e5507" title="Write the metapopulation to a compact binary-format output file. Write the metapopulation to a compac...">KTfwd::write_binary_metapop</a>, and write the population to an in-memory buffer such as <a href="http://www.cplusplus.com/reference/sstream/ostringstream/">std::ostringstream</a>. You may restore the population by reading the data from a <a href="http://www.cplusplus.com/reference/sstream/istringstream/">std::istringstream</a>.</p>
<p>Here is some pseudocode for an individual-based simulation:</p>
<div class="fragment"><div class="line"><span class="comment">//run a simulation...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//write it to a buffer:</span></div>
<div class="line">std::ostringstream buffer;</div>
<div class="line"><a class="code" href="../../da/d8b/namespaceKTfwd.html#a7e61ead953245fa0179b92971ad9dc1f">KTfwd::write_binary_pop</a>(&amp;gametes,&amp;mutations,&amp;diploids,std::bind(<a class="code" href="../../db/d91/structmwriter.html">mwriter</a>(),std::placeholders::_1,std::placeholders::_2),buffer);</div>
<div class="line"></div>
<div class="line"><span class="comment">//Now, if you want to restore it:</span></div>
<div class="line">std::istringstream inbuffer(buffer.str());</div>
<div class="line">decltype(mutations) mutations2;</div>
<div class="line">decltype(gametes) gametes2;</div>
<div class="line">decltype(diploids) diploids2;</div>
<div class="line">KTfwd::<a class="code" href="../../da/d8b/namespaceKTfwd.html#aa86f256af3adb31cc09ad797b3d76c6e">read_binary_pop</a>(&amp;gametes2,</div>
<div class="line">                         &amp;mutations2,</div>
<div class="line">                         &amp;diploids2,</div>
<div class="line">                         std::bind(<a class="code" href="../../d9/d61/structmreader.html">mreader</a>(),std::placeholders::_1),</div>
<div class="line">                         inbuffer);</div>
</div><!-- fragment --><p>This approach works because <a class="el" href="../../da/d8b/namespaceKTfwd.html#a7e61ead953245fa0179b92971ad9dc1f">KTfwd::write_binary_pop</a> and <a class="el" href="../../da/d8b/namespaceKTfwd.html#a21e90a90f379efd81081f3c07c9e5507" title="Write the metapopulation to a compact binary-format output file. Write the metapopulation to a compac...">KTfwd::write_binary_metapop</a> perform "deep copies" of the data, allowing the complete restoration of all the pointers, etc., stored in the containers.</p>
<h2>Writing to files</h2>
<p>You may use the same functions to write/read to from files. You may use and sort of <a href="http://www.cplusplus.com/reference/ostream/ostream/">std::ostream</a>-compatible object for output. You may use either a <a href="http://www.cplusplus.com/reference/istream/istream/">std::istream</a>-compatible object for input or a gzFile object from <a href="http://zlib.net">zlib</a>.</p>
<h2>Managing output from multiple independent processes</h2>
<p>In practice, we often implement simulations with the idea that one replicate will be run per process, and that we will spread a large number of processes across our cluster. Typically, we collect the output of these simulations into a single file. To do this, we implement POSIX-style advisory file locking. See <a href="https://github.com/molpopgen/BigDataFormats">here</a> for a discussion of how to do that using the low-level C functions found in &lt;fcntl.h&gt;. A more modern C++-based approach would be to use the <a href="http://www.boost.org">boost</a> synchronization library. See <a href="https://gist.github.com/molpopgen/651e4ac81253f34364f7">here</a> for simple examples.</p>
<h3>Why not use boost serialization?</h3>
<p>Cliff's notes version: this approach would work well for a single process writing lots of replicates to one file. However, the archives that this library creates do not support appending on to an existing library. This limitation is unfortunate, as being able to use this library would simplify some of the implementation. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
