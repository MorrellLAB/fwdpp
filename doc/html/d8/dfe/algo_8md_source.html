<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>fwdpp: md/algo.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">fwdpp
   &#160;<span id="projectnumber">0.5.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">md/algo.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d8/dfe/algo_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# Algorithmic details of recombination</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;(This document first appeared in __fwdpp__ 0.3.3.)</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;The release of __fwdpp__ 0.3.3 contained two significant improvements in the scalability of the code for large simulations.</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;## Simplifying crossing-over</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;Through __fwdpp__ 0.3.2, the algorithm for crosssing over went like this:</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;* Take the two gametes in a parent</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;* Recombine them at a set of breakpoints determined by the user-defined policy</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;* Randomly-pick one of the two recombinant gametes to pass on to the offspring.</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;In &quot;pictures&quot;, the algorithm went like:</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;* Starting with parental gametes: AAAAAA and BBBBBB</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;* Ending with recombinant gametes: AAABBB and BBBAAAA</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;* Pick one to pass on (say, AAABBB), and discard the other)</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;On obvious problem with this approach is that we are creating a gamete that we don&#39;t do anything with: the one that doesn&#39;t get passed on simply gets discarded, and is thus a waste of all the copying (of pointers to mutations) that it took to create that gamete.</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;Version 0.3.3 of the library introduced the following change (which I honestly wish I&#39;d thought of several years ago...):</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;* Take the two gametes in a parent, pg1 and pg2</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;* Randomly pick one to be the descendant.  If it is pg2, swap the pointers to pg1 and pg2.</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;* Create a single recombinant and assign the appropriate pointer as the new value of pg1</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;In &quot;pictures&quot;:</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;* Starting with parental gametes: pg1 = AAAAAA and pg2 = BBBBBB</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;* Half the time, swap pg1 and pg2</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;* Generate a single recombinant, either AAABBB _or_ BBBAAA</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;What are the consequences of this new method?  Let&#39;s start with the good:</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;* Reduced run-time.  I _think_ the benefit is typically 15-20%, but this change was not &quot;good science&quot;, as I also changed how memory for storing recombinant gametes was allocated (see next subsection).</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;And now, the bad:</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;* For a given random number seed, the output is different for programs compiled using 0.3.2 and 0.3.3.  This is because the &quot;Mendel&quot; step occurs earlier in 0.3.3, thus changing the context of all subsequent calls to the random number generator.</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;### Changing memory allocation patterns</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;Through __fwdpp__ 0.3.2, the library would allocate memory for the two recombinant gametes.  This occurred for every recombination event, meaning that for \f$\rho = 4Nr\f$, the expected number of containers created each generation was \f$4\rho\f$, as there are \f$4Nr\f$ expected recombination events each generation (2 parents per 2N offspring, each parent recombining at \f$r\f$ positions on average), and 4 containers needed per recombining parent (because pointers to neutral and selected mutations are stored separately).</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;The method describe above worked ok, but ultimately results in a massive number of calls for new memory over the course of a simulation.</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;In 0.3.3, we can cut the number of allocations in half because we generate half as many recombinant chromosomes (see above).   However, the library takes the following steps to reduce allocations even further:</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;* Programs must now manage the allocation of the two vectors required to store a recombinant.  Let&#39;s call them &quot;neutral&quot; and &quot;selected&quot;.</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;* They are declared in main(), and the programmer should use &quot;reserve&quot; to pre-allocate some memory for them.</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;* These containers are passed into recombination policies and emptied/filled as required.</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;The positives of the new approach are:</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;* Reduced  memory use.  We can now just let the vector class adjust its capacity as needed, and grow as needed during the simulation, resulting in many fewer requests for memory.</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;* In combo with the new crossing-over method (see above), run times are reduced.</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;The negative:</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;* Passing these containers to recombination policies represents an API change.</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;## Checking that a recombinant gamete is unique</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;__fwdpp__ uses doubly-linked lists for storing pointers (iterators) to mutations and gametes.  The advantage of these lists is that pointers remain valid after insertion/deletion to/from lists. (This is in contrast to the case with a vector/array, where insertion/removal triggers a reallocation, which often moves memory, resulting in &quot;pointer/iterator invalidation&quot;.)   The down-side of lists is that moving through them is relatively expensive.  They fragment memory over time because they use discontinuous storage, and therefore searching through them is expensive.</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;One of the goals of the library is to store objects once and only once.  Thus, after a recombination, we need to do the following:</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;* Ask if the recombinant gamete is unique.</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;* If not, we simply assign the pointer to the recombinant as the pointer to the version that we already have in a list</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;* If so, we insert the new gamete at the end of the list, and store a pointer to it.</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;Through __fwdpp__ 0.3.2, the library searched the entire gamete list to see if the recombinant already exists.   This search took \f$O(g)\f$ operations, where \f$g\f$ is the number of unique gametes in the population.  Such linear searches are slow for linked lists and scale terribly with increasing population size and/or mutation and/or recombination rate.</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;In 0.3.3, the linear searches are replaced with \f$O(log(g))\f$ lookups via a lookup table that is calculated internally every generation.</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;The lookup table associates the total number of mutations in a gamete (neutral + selected mutations) and the iterator to that gamete in the linked list.  Given a new gamete, we can find the _range_ of gametes in the lookup table with the same total number of mutations in logarithmic time.  If the size of that range is zero, then the new gamete is by definition unique, and we insert it.  Otherwise, we must compare the recombinant to all gamtes in the range, which is a linear serach, but this time over a much smaller range than what __fwdpp__ 0.3.2 was doing.</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;The plus sides:</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;* Massive improvements in the scalability of the simulation.  For the cost of building the lookup table, we replace \f$O(\rho/2)\f$ linear searches of a linked list with \f$O(\rho/2)\f$ logarithmic-time lookups.  Further, _we rarely have to do the secondary linear search!_</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;The down side (quibble):</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;* We must pass the lookup table on to the recombination policy, and thus we need an API change.   However, we&#39;ve already changed the API in 0.3.3 because of the changes to how recombination works, so this is a very nit-picking down-side.</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;### Details on the lookup table</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;(This section exists in hope that KRT reads it before trying to reinvent the wheel in the future.  Fat chance of that...)</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;During testing, I tried the following schemes for the lookup tables:</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;* std::vector&lt; std::pair&lt;std::int32_t, glist::iterator&gt; &gt;, sorted using either std::stable_sort or std::sort.</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;* std::multimap&lt; std::int32_t, glist::iterator &gt;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;* std::unordered_multimap&lt; std::int32_t, glist::iterator &gt;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;I benchmarked each approach with the following command line: </div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;~~~{sh}</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;#Keep seed the same for all three...</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;diploid_ind 10000 4000 4000 100000 10 1 SEED</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;~~~</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;All three lookup tables had very similar run-times and peak RAM use.  However, (my implementation using) the unordered_multimap resulted in simulations with incorrect distributions of summary statistics.</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;The library currently defaults to using the std::multimap.  Programs may be compiled using &quot;sorted vector of pairs&quot; approach by passing -DFWDPP_VECTOR_GLOOKUP to the compiler/preprocessor.</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.9.1
</small></address>
</body>
</html>
