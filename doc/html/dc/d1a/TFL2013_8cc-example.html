<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>fwdpp: TFL2013.cc</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">fwdpp
   &#160;<span id="projectnumber">0.2.9</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">TFL2013.cc</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*  \include TFL2013.cc</span></div>
<div class="line"><span class="comment">  Simulation from Thornton, Foran, and Long (2013) PLoS Genetics.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  Rewritten to use the fwdpp library v &gt;= 0.2.0</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  Implemented using gamete-based sampling.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  The output is 3 gzipped files:</span></div>
<div class="line"><span class="comment">  1. The entire population in &quot;ms&quot; format</span></div>
<div class="line"><span class="comment">  2. The phenotypes of the population</span></div>
<div class="line"><span class="comment">  3. </span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"><span class="preprocessor">#include &lt;config.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../df/df8/diploid_8hh.html">fwdpp/diploid.hh</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;Sequence/SimData.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;utility&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;zlib.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span>std;</div>
<div class="line"><span class="keyword">using</span> Sequence::SimData;</div>
<div class="line"><span class="keyword">using namespace </span>KTfwd;</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span><a name="_a0"></a><a class="code" href="../../de/d4d/structmutation__with__age.html">mutation_with_age</a> : <span class="keyword">public</span> <a name="_a1"></a><a class="code" href="../../d1/da4/structKTfwd_1_1mutation__base.html">mutation_base</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">mutable</span> <span class="keywordtype">unsigned</span> o;</div>
<div class="line">  <span class="keywordtype">double</span> s;</div>
<div class="line">  <span class="keywordtype">char</span> label; <span class="comment">//&#39;A&#39; = &quot;amino acid&quot;, &#39;S&#39; = &quot;synonymous&quot;  Only used here in that A = causative, S = neutral.</span></div>
<div class="line">  <a class="code" href="../../de/d4d/structmutation__with__age.html">mutation_with_age</a>( <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; position, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; sel_coeff,</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> &amp; count,<span class="keyword">const</span> <span class="keywordtype">unsigned</span> &amp; origin, <span class="keyword">const</span> <span class="keywordtype">char</span> &amp; ch,</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">bool</span> &amp; n=<span class="keyword">true</span>) </div>
<div class="line">    : <a class="code" href="../../d1/da4/structKTfwd_1_1mutation__base.html">mutation_base</a>(position,count,n),o(origin),s(sel_coeff),label(ch)</div>
<div class="line">  {</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordtype">bool</span> operator==(<span class="keyword">const</span> <a class="code" href="../../de/d4d/structmutation__with__age.html">mutation_with_age</a> &amp; rhs)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span>( fabs(this-&gt;pos-rhs.<a name="a2"></a><a class="code" href="../../d1/da4/structKTfwd_1_1mutation__base.html#aed95181f38c8e17b19a7a9da4b373b03">pos</a>) &lt;= std::numeric_limits&lt;double&gt;::epsilon() &amp;&amp;</div>
<div class="line">            this-&gt;s == rhs.<a name="a3"></a><a class="code" href="../../de/d4d/structmutation__with__age.html#a85f3c3c62fb469e3e38e5a5b3ec2d5dc">s</a> );</div>
<div class="line">  }     </div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <a class="code" href="../../de/d4d/structmutation__with__age.html">mutation_with_age</a> <a name="a4"></a><a class="code" href="../../df/da3/TFL2013_8cc.html#aa6121c6414de72206220b07fcb59a201">mtype</a>;</div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d3/dab/common__gamete_8hpp.html">common_gamete.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#if defined(HAVE_BOOST_VECTOR) &amp;&amp; defined(HAVE_BOOST_LIST) &amp;&amp; defined(HAVE_BOOST_UNORDERED_SET) &amp;&amp; defined(HAVE_BOOST_POOL_ALLOC) &amp;&amp; defined(HAVE_BOOST_HASH) &amp;&amp; !defined(USE_STANDARD_CONTAINERS)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">typedef</span> boost::container::vector&lt;mtype&gt; <a name="a5"></a><a class="code" href="../../df/da3/TFL2013_8cc.html#a1e738991be300fce0a7f757f3d7b8b95">mvector</a>;</div>
<div class="line"><span class="keyword">typedef</span> boost::container::vector&lt;unsigned&gt; <a name="a6"></a><a class="code" href="../../df/da3/TFL2013_8cc.html#a9177f9ed29c0d36758db138b8ffab0f4">ftvector</a>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">typedef</span> std::vector&lt;mtype&gt; <a class="code" href="../../df/da3/TFL2013_8cc.html#a1e738991be300fce0a7f757f3d7b8b95">mvector</a>;</div>
<div class="line"><span class="keyword">typedef</span> std::vector&lt;unsigned&gt; <a class="code" href="../../df/da3/TFL2013_8cc.html#a9177f9ed29c0d36758db138b8ffab0f4">ftvector</a>;</div>
<div class="line"><span class="preprocessor">#endif </span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">//Calculates the genetic contribution to a diploid&#39;s phenotype</span></div>
<div class="line"><span class="keyword">struct </span><a name="_a7"></a><a class="code" href="../../d0/dd7/structdisease__effect.html">disease_effect</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">typedef</span> <span class="keywordtype">double</span> result_type;</div>
<div class="line">  <span class="keyword">template</span>&lt; <span class="keyword">typename</span> iterator_type &gt;</div>
<div class="line">  <span class="keyword">inline</span> std::pair&lt;double,double&gt; operator()(<span class="keyword">const</span> iterator_type &amp; g1, <span class="keyword">const</span> iterator_type &amp; g2,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; sd, gsl_rng * <a name="a8"></a><a class="code" href="../../d9/d1d/mlocusCrossoverTest_8cc.html#a53b3e4bb1bd287d2150b9c128e15a316">r</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="comment">//The effect of each allele is additive across mutations</span></div>
<div class="line">    <span class="keywordtype">double</span> e1 = 0.,e2=0.;</div>
<div class="line">    <span class="keyword">typename</span>  iterator_type::value_type::mutation_container::const_iterator itr;</div>
<div class="line">    <span class="keywordflow">for</span>(itr = g1-&gt;smutations.begin() ; itr != g1-&gt;smutations.end() ; ++itr)</div>
<div class="line">      {</div>
<div class="line">        e1 += (*itr)-&gt;s;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">for</span>(itr = g2-&gt;smutations.begin() ; itr != g2-&gt;smutations.end() ; ++itr)</div>
<div class="line">      {</div>
<div class="line">        e2 += (*itr)-&gt;s;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordtype">double</span> effect = pow( e1*e2, 0.5 );</div>
<div class="line">    <span class="keywordflow">return</span> make_pair(effect, gsl_ran_gaussian(r,sd));</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">//calculates the fitess of a diploid</span></div>
<div class="line"><span class="keyword">struct </span><a name="_a9"></a><a class="code" href="../../dd/dd4/structdisease__effect__to__fitness.html">disease_effect_to_fitness</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">typedef</span> <span class="keywordtype">double</span> result_type;</div>
<div class="line">  <span class="keyword">template</span>&lt; <span class="keyword">typename</span> iterator_type &gt;</div>
<div class="line">  <span class="keyword">inline</span> <span class="keywordtype">double</span> operator()(<span class="keyword">const</span> iterator_type &amp; g1, <span class="keyword">const</span> iterator_type &amp; g2,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; sd, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; sd_s,gsl_rng * r)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    pair&lt;double,double&gt; effect = <a class="code" href="../../d0/dd7/structdisease__effect.html">disease_effect</a>()(g1,g2,sd,<a class="code" href="../../d9/d1d/mlocusCrossoverTest_8cc.html#a53b3e4bb1bd287d2150b9c128e15a316">r</a>);</div>
<div class="line">    <span class="keywordtype">double</span> fitness = exp( (-1. * pow(effect.first+effect.second,2.))/(2.*pow(sd_s,2)) );</div>
<div class="line">    <span class="keywordflow">return</span> ( fitness );</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">  Infinitely-many sites mutation.</span></div>
<div class="line"><span class="comment">  Deleterious mutations get &quot;A&quot; label for &quot;amino-acid&quot;.</span></div>
<div class="line"><span class="comment">  Neutral get &quot;S&quot; for synonymous</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">struct </span><a name="_a10"></a><a class="code" href="../../d0/d35/structmutation__model.html">mutation_model</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">typedef</span> <a name="_a11"></a><a class="code" href="../../d1/d7f/structKTfwd_1_1mutation.html">mtype</a> result_type;</div>
<div class="line">  <span class="keyword">inline</span> result_type operator()( gsl_rng * r, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp; ttl_generations,</div>
<div class="line">                                 <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; s, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; ud, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; un, <span class="keyword">const</span>  <a class="code" href="../../dd/d6c/siteDepFitness_8cc.html#a5343ffa32173d1ca8624a7d19e41f658">mlist</a> * mutations,</div>
<div class="line">                                 <a class="code" href="../../d8/d48/bneck__selection__dist_8cc.html#a0731e2ed14d3858427a2552e4944b778">lookup_table_type</a> * lookup,</div>
<div class="line">                                 <span class="keyword">const</span> <span class="keywordtype">bool</span> dist_effects = <span class="keyword">false</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordtype">double</span> pos = gsl_rng_uniform(r);</div>
<div class="line">    <span class="keywordflow">while</span>(lookup-&gt;find(pos) != lookup-&gt;end())</div>
<div class="line">      {</div>
<div class="line">        pos = gsl_rng_uniform(r);</div>
<div class="line">      }</div>
<div class="line">    lookup-&gt;insert(pos);</div>
<div class="line">    <span class="keywordflow">if</span>( gsl_rng_uniform(r) &lt;= ud/(ud+un) )</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">if</span>( ! dist_effects )</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="../../df/da3/TFL2013_8cc.html#aa6121c6414de72206220b07fcb59a201">mtype</a>(pos,s,1,ttl_generations,<span class="charliteral">&#39;A&#39;</span>,<span class="keyword">false</span>);</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="../../df/da3/TFL2013_8cc.html#aa6121c6414de72206220b07fcb59a201">mtype</a>(pos,gsl_ran_exponential(r,s),1,ttl_generations,<span class="charliteral">&#39;A&#39;</span>,<span class="keyword">false</span>);</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="../../df/da3/TFL2013_8cc.html#aa6121c6414de72206220b07fcb59a201">mtype</a>(pos,0.,1,ttl_generations,<span class="charliteral">&#39;S&#39;</span>,<span class="keyword">true</span>);</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a name="a12"></a><a class="code" href="../../df/da3/TFL2013_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> ( argc != 16)</div>
<div class="line">    {</div>
<div class="line">      cerr &lt;&lt; <span class="stringliteral">&quot;Too few arguments.\n&quot;</span></div>
<div class="line">           &lt;&lt; <span class="stringliteral">&quot;Usage: TFL2013 N mu_disease mu_neutral r s dist_effects sd sd_s gens_burnin gens_evolve popfile.gz phenotypes.gz effects.gz nreps seed\n&quot;</span>;</div>
<div class="line">      exit(10);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordtype">int</span> argument=1;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> N = atoi(argv[argument++]);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> mu_disease = atof(argv[argument++]);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> mu_neutral = atof(argv[argument++]);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> littler = atof(argv[argument++])/2.; <span class="comment">//convert per-diploid into per-gamete</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> s = atof(argv[argument++]);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> dist_effects = atoi(argv[argument++]);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> sd = atof(argv[argument++]);<span class="comment">//sigma for &quot;E&quot;</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> sd_s = atof(argv[argument++]);<span class="comment">//sigma for selection</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> ngens_burnin = atoi(argv[argument++]);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> ngens_evolve = atoi(argv[argument++]);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * ofn = argv[argument++];</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * ofn2 = argv[argument++];</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * ofn3 = NULL;</div>
<div class="line">  <span class="keywordflow">if</span>( dist_effects )</div>
<div class="line">    {</div>
<div class="line">      ofn3 = argv[argument++];</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordtype">int</span> nreps=atoi(argv[argument++]);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> seed = atoi(argv[argument++]);</div>
<div class="line"></div>
<div class="line">  cerr &lt;&lt; <span class="charliteral">&#39;#&#39;</span>;</div>
<div class="line">  <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> i=0;i&lt;argc;++i)</div>
<div class="line">    {</div>
<div class="line">      cerr &lt;&lt; argv[i] &lt;&lt; <span class="charliteral">&#39; &#39;</span>;</div>
<div class="line">    }</div>
<div class="line">  cerr &lt;&lt; endl;</div>
<div class="line"></div>
<div class="line">  gsl_rng * r =  gsl_rng_alloc(gsl_rng_taus2);</div>
<div class="line">  gsl_rng_set(r,seed);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">while</span>(nreps--)</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="../../d8/d48/bneck__selection__dist_8cc.html#a0731e2ed14d3858427a2552e4944b778">lookup_table_type</a> lookup;</div>
<div class="line">      <span class="comment">//the population begins with 1 gamete with no mutations</span></div>
<div class="line">      <a class="code" href="../../d9/d1d/mlocusCrossoverTest_8cc.html#afd5b74e0108d624225532de98a470a36">gvector</a> gametes(1,<a name="a13"></a><a class="code" href="../../d1/dbe/crossoverTest_8cc.html#ace9428d4aa6205eaf777c2c9f398d9ea">gtype</a>(2*N));</div>
<div class="line">      <a class="code" href="../../dd/d6c/siteDepFitness_8cc.html#a5343ffa32173d1ca8624a7d19e41f658">mlist</a> mutations;</div>
<div class="line">      <a class="code" href="../../df/da3/TFL2013_8cc.html#a1e738991be300fce0a7f757f3d7b8b95">mvector</a> fixations;      </div>
<div class="line">      <a class="code" href="../../df/da3/TFL2013_8cc.html#a9177f9ed29c0d36758db138b8ffab0f4">ftvector</a> fixation_times;</div>
<div class="line"></div>
<div class="line">      <span class="keywordtype">unsigned</span> generation;</div>
<div class="line">      <span class="keywordtype">unsigned</span> ttl_gen = 0;</div>
<div class="line">      <span class="keywordtype">double</span> wbar=1;</div>
<div class="line">      <span class="keywordflow">for</span>( generation = 0; generation &lt; ngens_burnin; ++generation,++ttl_gen )</div>
<div class="line">        {</div>
<div class="line">          <span class="comment">//a generation is drift, then mutation, recombination</span></div>
<div class="line">          wbar = <a name="a14"></a><a class="code" href="../../da/d8b/namespaceKTfwd.html#a946efaa4a6095f4f2aadda44a809a477">sample_diploid</a>(r,&amp;gametes,2*N,std::bind(<a class="code" href="../../dd/dd4/structdisease__effect__to__fitness.html">disease_effect_to_fitness</a>(),std::placeholders::_1,std::placeholders::_2,sd,sd_s,r),</div>
<div class="line">                                std::bind(<a name="_a15"></a><a class="code" href="../../d4/de8/structKTfwd_1_1mutation__remover.html">KTfwd::mutation_remover</a>(),std::placeholders::_1,0,2*N));       </div>
<div class="line">          <a name="a16"></a><a class="code" href="../../da/d8b/namespaceKTfwd.html#a84e666ea27d38bdfc539ffd23653eaa9">remove_fixed_lost</a>(&amp;mutations,&amp;fixations,&amp;fixation_times,&amp;lookup,generation,2*N);</div>
<div class="line">          assert(<a name="a17"></a><a class="code" href="../../da/d8b/namespaceKTfwd.html#a728e20cb60f82b818b5cc570722079a4">check_sum</a>(gametes,2*N));</div>
<div class="line">          <span class="keywordtype">unsigned</span> nmuts= <a name="a18"></a><a class="code" href="../../da/d8b/namespaceKTfwd.html#a9566be0bd568e2e75b02b1f46457c25c">mutate</a>(r,&amp;gametes,&amp;mutations,mu_disease+mu_neutral,std::bind(<a class="code" href="../../d0/d35/structmutation__model.html">mutation_model</a>(),r,ttl_gen,s,mu_disease,mu_neutral,&amp;mutations,&amp;lookup,dist_effects),</div>
<div class="line">                                 <a name="_a19"></a><a class="code" href="../../d1/dcc/structKTfwd_1_1push__back__gamete.html">push_back_gamete</a>(),std::bind(insert_mutation_at_end&lt;mtype,mlist &gt;,std::placeholders::_1,std::placeholders::_2));</div>
<div class="line">          assert(<a class="code" href="../../da/d8b/namespaceKTfwd.html#a728e20cb60f82b818b5cc570722079a4">check_sum</a>(gametes,2*N));</div>
<div class="line">          <span class="keywordtype">unsigned</span> nrec = <a name="a20"></a><a class="code" href="../../da/d8b/namespaceKTfwd.html#a41bccb4fd1108616d626e371c3cf83c4">recombine</a>(r, &amp;gametes, 2*N, littler, std::bind(gsl_rng_uniform,r));</div>
<div class="line">          assert(<a class="code" href="../../da/d8b/namespaceKTfwd.html#a728e20cb60f82b818b5cc570722079a4">check_sum</a>(gametes,2*N));</div>
<div class="line">        }</div>
<div class="line">      <span class="keywordtype">unsigned</span> nfix = fixations.size();</div>
<div class="line">      <span class="keywordflow">for</span>( generation = 0; generation &lt; ngens_evolve; ++generation,++ttl_gen )</div>
<div class="line">        {</div>
<div class="line">          <span class="comment">//a generation is drift, then mutation, recombination</span></div>
<div class="line">          <span class="keywordtype">double</span> wbar = <a class="code" href="../../da/d8b/namespaceKTfwd.html#a946efaa4a6095f4f2aadda44a809a477">sample_diploid</a>(r,&amp;gametes,2*N,std::bind(<a class="code" href="../../dd/dd4/structdisease__effect__to__fitness.html">disease_effect_to_fitness</a>(),std::placeholders::_1,std::placeholders::_2,sd,sd_s,r),</div>
<div class="line">                                       std::bind(<a class="code" href="../../d4/de8/structKTfwd_1_1mutation__remover.html">KTfwd::mutation_remover</a>(),std::placeholders::_1,0,2*N));       </div>
<div class="line">          <a class="code" href="../../da/d8b/namespaceKTfwd.html#a84e666ea27d38bdfc539ffd23653eaa9">remove_fixed_lost</a>(&amp;mutations,&amp;fixations,&amp;fixation_times,&amp;lookup,generation,2*N);</div>
<div class="line">          assert(<a class="code" href="../../da/d8b/namespaceKTfwd.html#a728e20cb60f82b818b5cc570722079a4">check_sum</a>(gametes,2*N));</div>
<div class="line">          <span class="keywordtype">unsigned</span> nmuts= <a class="code" href="../../da/d8b/namespaceKTfwd.html#a9566be0bd568e2e75b02b1f46457c25c">mutate</a>(r,&amp;gametes,&amp;mutations,mu_disease+mu_neutral,std::bind(<a class="code" href="../../d0/d35/structmutation__model.html">mutation_model</a>(),r,ttl_gen,s,mu_disease,mu_neutral,&amp;mutations,&amp;lookup,dist_effects),</div>
<div class="line">                                 <a class="code" href="../../d1/dcc/structKTfwd_1_1push__back__gamete.html">push_back_gamete</a>(),std::bind(insert_mutation_at_end&lt;mtype,mlist &gt;,std::placeholders::_1,std::placeholders::_2));</div>
<div class="line">          assert(<a class="code" href="../../da/d8b/namespaceKTfwd.html#a728e20cb60f82b818b5cc570722079a4">check_sum</a>(gametes,2*N));</div>
<div class="line">          <span class="keywordtype">unsigned</span> nrec = <a class="code" href="../../da/d8b/namespaceKTfwd.html#a41bccb4fd1108616d626e371c3cf83c4">recombine</a>(r, &amp;gametes, 2*N, littler, std::bind(gsl_rng_uniform,r));</div>
<div class="line">          assert(<a class="code" href="../../da/d8b/namespaceKTfwd.html#a728e20cb60f82b818b5cc570722079a4">check_sum</a>(gametes,2*N));</div>
<div class="line">        }</div>
<div class="line">      <a class="code" href="../../da/d8b/namespaceKTfwd.html#a84e666ea27d38bdfc539ffd23653eaa9">remove_fixed_lost</a>(&amp;mutations,&amp;fixations,&amp;fixation_times,generation,2*N);</div>
<div class="line"></div>
<div class="line">      <span class="comment">//so now, make 2N diploids from the population as it stands, and assign a phenotype value to each individual</span></div>
<div class="line">      vector&lt; pair&lt; gvector::iterator,gvector::iterator &gt; &gt; diploids;</div>
<div class="line">      vector&lt; unsigned &gt; gamcounts;</div>
<div class="line">      vector&lt; double &gt; phenotypes;</div>
<div class="line">      <span class="keywordtype">unsigned</span> gamsum=0;</div>
<div class="line">      <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> i=0;i&lt;gametes.size();++i)</div>
<div class="line">        {</div>
<div class="line">          gamcounts.push_back(gametes[i].n);</div>
<div class="line">          gamsum += gametes[i].n;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">      ostringstream buffer;</div>
<div class="line">      <span class="comment">//generate the 2N diploids</span></div>
<div class="line">      <span class="keywordtype">unsigned</span> gam1,gam2,j,k,l;</div>
<div class="line">      <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> i=0;i&lt;N;)</div>
<div class="line">        {</div>
<div class="line">          gam1 = unsigned(gsl_ran_flat(r,0,gamsum))+1;</div>
<div class="line">          gam2 = unsigned(gsl_ran_flat(r,0,gamsum))+1;</div>
<div class="line">          j=0;</div>
<div class="line">          l=0;</div>
<div class="line">          <span class="keywordflow">for</span>( ;l &lt; gamcounts.size() ; ++l)</div>
<div class="line">            {</div>
<div class="line">              j += gamcounts[l];</div>
<div class="line">              <span class="keywordflow">if</span>( j &gt;= gam1 ) { j=l;<span class="keywordflow">break</span>; }</div>
<div class="line">            }</div>
<div class="line">          k=0;</div>
<div class="line">          l=0;</div>
<div class="line">          <span class="keywordflow">for</span>( ;l &lt; gamcounts.size() ; ++l)</div>
<div class="line">            {</div>
<div class="line">              k += gamcounts[l];</div>
<div class="line">              <span class="keywordflow">if</span>( k &gt;= gam2 ) { k=l;<span class="keywordflow">break</span>; }</div>
<div class="line">            }</div>
<div class="line">          <span class="keywordflow">if</span>( ( k==j &amp;&amp; gamcounts[k]&gt;1 ) ||</div>
<div class="line">              ( k!=j &amp;&amp; gamcounts[k]&gt;0 &amp;&amp; gamcounts[j]&gt;0 ) )</div>
<div class="line">            {</div>
<div class="line">              diploids.push_back( std::make_pair( gametes.begin()+j, gametes.begin()+k ) );</div>
<div class="line">              pair&lt;double,double&gt; effect = <a class="code" href="../../d0/dd7/structdisease__effect.html">disease_effect</a>()(gametes.begin()+j,gametes.begin()+k,sd,<a class="code" href="../../d9/d1d/mlocusCrossoverTest_8cc.html#a53b3e4bb1bd287d2150b9c128e15a316">r</a>);</div>
<div class="line">              buffer &lt;&lt; effect.first &lt;&lt; <span class="charliteral">&#39;\t&#39;</span> &lt;&lt; effect.second &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">              gamcounts[j]--;</div>
<div class="line">              gamcounts[k]--;</div>
<div class="line">              gamsum -= 2;</div>
<div class="line">              ++i;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">      ofstream phenofile(ofn2);</div>
<div class="line">      phenofile &lt;&lt; buffer.str();</div>
<div class="line">      phenofile.close();</div>
<div class="line">      buffer.str(<span class="keywordtype">string</span>());</div>
<div class="line">      assert( gamsum == 0 );</div>
<div class="line"></div>
<div class="line">      <span class="comment">//print out num deleterious mutations vs effect</span></div>
<div class="line">      vector&lt; pair&lt;double,string&gt; &gt; neutral,selected;</div>
<div class="line">      SimData msneut,mssel;</div>
<div class="line"></div>
<div class="line">      std::function&lt;bool(const std::pair&lt;double,std::string&gt; &amp;, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;)&gt; sitefinder = [](<span class="keyword">const</span> std::pair&lt;double,std::string&gt; &amp; site,</div>
<div class="line">                                                                                                 <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; d ) </div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">return</span> std::fabs(site.first-d) &lt;= std::numeric_limits&lt;double&gt;::epsilon();</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> i=0;i&lt;diploids.size();++i)</div>
<div class="line">        {</div>
<div class="line">          <span class="comment">//neutral mutations</span></div>
<div class="line">          <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <a name="_a21"></a><a class="code" href="../../de/d89/structmut.html">mut</a> = 0 ; <a class="code" href="../../de/d89/structmut.html">mut</a> &lt; diploids[i].first-&gt;mutations.size() ; ++<a name="a22"></a><a class="code" href="../../d1/dbe/crossoverTest_8cc.html#ad9baf2d3214da5c5b5710791a07c22a6">mut</a> )</div>
<div class="line">            {</div>
<div class="line">              vector&lt; pair&lt;double,string&gt; &gt;::iterator itr = find_if(neutral.begin(),neutral.end(),</div>
<div class="line">                                                                    std::bind(sitefinder,std::placeholders::_1, diploids[i].first-&gt;mutations[<a class="code" href="../../de/d89/structmut.html">mut</a>]-&gt;pos));</div>
<div class="line"></div>
<div class="line">              <span class="keywordflow">if</span>( itr == neutral.end() )</div>
<div class="line">                {</div>
<div class="line">                  neutral.push_back( std::make_pair(diploids[i].first-&gt;mutations[<a class="code" href="../../de/d89/structmut.html">mut</a>]-&gt;pos,std::string(2*N,<span class="charliteral">&#39;0&#39;</span>)) );</div>
<div class="line">                  neutral[neutral.size()-1].second[2*i] = <span class="charliteral">&#39;1&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">              <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                  itr-&gt;second[2*i] = <span class="charliteral">&#39;1&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">          <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <a class="code" href="../../de/d89/structmut.html">mut</a> = 0 ; <a class="code" href="../../de/d89/structmut.html">mut</a> &lt; diploids[i].second-&gt;mutations.size() ; ++<a class="code" href="../../d1/dbe/crossoverTest_8cc.html#ad9baf2d3214da5c5b5710791a07c22a6">mut</a> )</div>
<div class="line">            {</div>
<div class="line">              vector&lt; pair&lt;double,string&gt; &gt;::iterator itr = find_if(neutral.begin(),neutral.end(),</div>
<div class="line">                                                                    std::bind(sitefinder,std::placeholders::_1, diploids[i].second-&gt;mutations[<a class="code" href="../../de/d89/structmut.html">mut</a>]-&gt;pos));</div>
<div class="line">              <span class="keywordflow">if</span>( itr == neutral.end() )</div>
<div class="line">                {</div>
<div class="line">                  neutral.push_back( std::make_pair(diploids[i].second-&gt;mutations[<a class="code" href="../../de/d89/structmut.html">mut</a>]-&gt;pos,std::string(2*N,<span class="charliteral">&#39;0&#39;</span>)) );</div>
<div class="line">                  neutral[neutral.size()-1].second[2*i+1] = <span class="charliteral">&#39;1&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">              <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                  itr-&gt;second[2*i+1] = <span class="charliteral">&#39;1&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">          <span class="comment">//selected</span></div>
<div class="line">          <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <a class="code" href="../../de/d89/structmut.html">mut</a> = 0 ; <a class="code" href="../../de/d89/structmut.html">mut</a> &lt; diploids[i].first-&gt;smutations.size() ; ++<a class="code" href="../../d1/dbe/crossoverTest_8cc.html#ad9baf2d3214da5c5b5710791a07c22a6">mut</a> )</div>
<div class="line">            {</div>
<div class="line">              vector&lt; pair&lt;double,string&gt; &gt;::iterator itr = find_if(selected.begin(),selected.end(),</div>
<div class="line">                                                                    std::bind(sitefinder,std::placeholders::_1, diploids[i].first-&gt;mutations[<a class="code" href="../../de/d89/structmut.html">mut</a>]-&gt;pos));</div>
<div class="line">              <span class="keywordflow">if</span>( itr == selected.end() )</div>
<div class="line">                {</div>
<div class="line">                  selected.push_back( std::make_pair(diploids[i].first-&gt;smutations[<a class="code" href="../../de/d89/structmut.html">mut</a>]-&gt;pos,std::string(2*N,<span class="charliteral">&#39;0&#39;</span>)) );</div>
<div class="line">                  selected[selected.size()-1].second[2*i] = <span class="charliteral">&#39;1&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">              <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                  itr-&gt;second[2*i] = <span class="charliteral">&#39;1&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">          <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <a class="code" href="../../de/d89/structmut.html">mut</a> = 0 ; <a class="code" href="../../de/d89/structmut.html">mut</a> &lt; diploids[i].second-&gt;smutations.size() ; ++<a class="code" href="../../d1/dbe/crossoverTest_8cc.html#ad9baf2d3214da5c5b5710791a07c22a6">mut</a> )</div>
<div class="line">            {</div>
<div class="line">              vector&lt; pair&lt;double,string&gt; &gt;::iterator itr = find_if(selected.begin(),selected.end(),</div>
<div class="line">                                                                    std::bind(sitefinder,std::placeholders::_1, diploids[i].second-&gt;mutations[<a class="code" href="../../de/d89/structmut.html">mut</a>]-&gt;pos));</div>
<div class="line">              <span class="keywordflow">if</span>( itr == selected.end() )</div>
<div class="line">                {</div>
<div class="line">                  selected.push_back( make_pair(diploids[i].second-&gt;smutations[<a class="code" href="../../de/d89/structmut.html">mut</a>]-&gt;pos,std::string(2*N,<span class="charliteral">&#39;0&#39;</span>)) );</div>
<div class="line">                  selected[selected.size()-1].second[2*i+1] = <span class="charliteral">&#39;1&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">              <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                  itr-&gt;second[2*i+1] = <span class="charliteral">&#39;1&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">      std::sort(neutral.begin(),neutral.end(),</div>
<div class="line">                [](std::pair&lt;double,std::string&gt; lhs,</div>
<div class="line">                   std::pair&lt;double,std::string&gt; rhs) { <span class="keywordflow">return</span> lhs.first &lt; rhs.first; });</div>
<div class="line">      std::sort(selected.begin(),selected.end(),</div>
<div class="line">                [](std::pair&lt;double,std::string&gt; lhs,</div>
<div class="line">                   std::pair&lt;double,std::string&gt; rhs) { <span class="keywordflow">return</span> lhs.first &lt; rhs.first; });</div>
<div class="line">      msneut.assign(neutral.begin(),neutral.end());</div>
<div class="line">      mssel.assign(selected.begin(),selected.end());</div>
<div class="line"></div>
<div class="line">      <span class="comment">//filtering_ostream msfile;</span></div>
<div class="line">      gzFile gzout = gzopen(ofn,<span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line">      buffer &lt;&lt; msneut &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>&lt;&lt;mssel&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">      gzwrite(gzout,buffer.str().c_str(),buffer.str().size());</div>
<div class="line">      gzclose(gzout);</div>
<div class="line">      buffer.str(<span class="keywordtype">string</span>());</div>
<div class="line"></div>
<div class="line">      buffer &lt;&lt; <span class="stringliteral">&quot;//\n&quot;</span>;</div>
<div class="line">      <span class="keywordflow">for</span>(mlist::iterator i = mutations.begin() ; i != mutations.end() ; ++i )</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> (!i-&gt;neutral)</div>
<div class="line">            {</div>
<div class="line">              buffer &lt;&lt; i-&gt;pos &lt;&lt; <span class="charliteral">&#39;\t&#39;</span> &lt;&lt; i-&gt;s &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">      gzout = gzopen(ofn3,<span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line">      gzwrite(gzout,buffer.str().c_str(),buffer.str().size());</div>
<div class="line">      gzclose(gzout);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
